version: '3.8'

services:
  promptsrc:
    build:
      context: .
      args:
        REACT_APP_BACKEND_URL: ${REACT_APP_BACKEND_URL:-http://localhost}
    ports:
      - "80:80"
    environment:
      # JWT & Auth
      - JWT_SECRET_KEY=${JWT_SECRET_KEY:-change_this_secret_in_production}
      - GITHUB_CLIENT_ID=${GITHUB_CLIENT_ID:-}
      - GITHUB_CLIENT_SECRET=${GITHUB_CLIENT_SECRET:-}
      - GITHUB_REDIRECT_URI=${GITHUB_REDIRECT_URI:-http://localhost/api/auth/github/callback}
      - FRONTEND_URL=${FRONTEND_URL:-http://localhost}
      # Database (sqlite or postgresql)
      - DATABASE_TYPE=${DATABASE_TYPE:-sqlite}
      - DATABASE_URL=${DATABASE_URL:-sqlite:///app/backend/promptsrc.db}
      - POSTGRES_URL=${POSTGRES_URL:-}
      # OpenAI-compatible API (for embeddings & LLM)
      - OPENAI_API_BASE=${OPENAI_API_BASE:-https://api.openai.com/v1}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - EMBEDDING_MODEL=${EMBEDDING_MODEL:-text-embedding-3-small}
      - LLM_MODEL=${LLM_MODEL:-gpt-4o-mini}
      # Qdrant
      - QDRANT_URL=${QDRANT_URL:-http://qdrant:6333}
      - QDRANT_API_KEY=${QDRANT_API_KEY:-}
      # Zendata PII API
      - ZENDATA_API_URL=${ZENDATA_API_URL:-}
      - ZENDATA_API_KEY=${ZENDATA_API_KEY:-}
    volumes:
      - promptsrc_data:/app/backend/data
    depends_on:
      - qdrant
    restart: unless-stopped

  qdrant:
    image: qdrant/qdrant:latest
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - qdrant_data:/qdrant/storage
    environment:
      - QDRANT__SERVICE__GRPC_PORT=6334
    restart: unless-stopped

volumes:
  promptsrc_data:
  qdrant_data:
