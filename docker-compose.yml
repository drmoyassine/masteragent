version: '3.8'

services:
  promptsrc:
    build:
      context: .
      args:
        REACT_APP_BACKEND_URL: ${REACT_APP_BACKEND_URL:-http://localhost}
    ports:
      - "${PORT:-8080}:80"
    environment:
      # JWT & Auth
      - JWT_SECRET_KEY=${JWT_SECRET_KEY:-change_this_secret_in_production}
      - GITHUB_CLIENT_ID=${GITHUB_CLIENT_ID:-}
      - GITHUB_CLIENT_SECRET=${GITHUB_CLIENT_SECRET:-}
      - GITHUB_REDIRECT_URI=${GITHUB_REDIRECT_URI:-http://localhost/api/auth/github/callback}
      - FRONTEND_URL=${FRONTEND_URL:-http://localhost}
      # Database (sqlite or postgresql)
      - DATABASE_TYPE=${DATABASE_TYPE:-sqlite}
      - DATABASE_URL=${DATABASE_URL:-sqlite:///app/backend/promptsrc.db}
      - POSTGRES_URL=${POSTGRES_URL:-}
      # Qdrant
      - QDRANT_URL=${QDRANT_URL:-http://qdrant:6333}
      - QDRANT_API_KEY=${QDRANT_API_KEY:-}
      # GLiNER NER Service (optional)
      - ENABLE_GLINER=${ENABLE_GLINER:-false}
      - GLINER_URL=${GLINER_URL:-http://gliner:8002}
    volumes:
      - promptsrc_data:/app/backend/data
      - promptsrc_prompts:/app/backend/local_prompts
      - promptsrc_db:/app/backend/db
    depends_on:
      - qdrant
    restart: unless-stopped

  qdrant:
    image: qdrant/qdrant:latest
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - qdrant_data:/qdrant/storage
    environment:
      - QDRANT__SERVICE__GRPC_PORT=6334
    restart: unless-stopped

  # GLiNER NER Service (optional - use profile to enable)
  # To start with GLiNER: docker-compose --profile gliner up -d
  # Or set ENABLE_GLINER=true in .env and use: docker-compose up -d
  gliner:
    profiles:
      - gliner
    build:
      context: ./gliner
      dockerfile: Dockerfile
    ports:
      - "8002:8002"
    volumes:
      - gliner_cache:/root/.cache
    environment:
      - MODEL_NAME=${GLINER_MODEL:-urchade/gliner_multi}
    restart: unless-stopped

volumes:
  promptsrc_data:
  promptsrc_prompts:
  promptsrc_db:
  qdrant_data:
  gliner_cache:
